#!/bin/bash

has() { type -p "$1" > /dev/null; }

if [ "$HOSTNAME" == "rex" ] ; then
    #if we are on the server we back up to the cloud.
    BACKUP_DIRS=("$HOME" "/media/4tbRaid" "/etc" "/opt")
    SERVER_DIR=""
    PROTOCOL="rclone"
    SERVER="dropbox"
else
    BACKUP_DIRS=("$HOME" "/etc")
    # HOSTNAME="$(hostname)"
    SERVER_DIR="/media/4tbRaid/Backups/"
    PROTOCOL="sftp"
    SERVER="fritz@rex"
fi

if [ -n "$TERMUX_VERSION" ] ; then
    HOSTNAME="Termux"
fi

if has restic ; then
    printf "\e[0;32mFound restic.\n\033[0m"
else
    printf "\e[0;31mrestic not found. This backup script will not work.\n\033[0m"
    exit 1
fi

#restic as root is useful for root-owned files in /etc
#no termux detection needed
if has doas ; then
    ROOT_STRING="doas"
elif has sudo ; then
    ROOT_STRING="sudo"
else
    ROOT_STRING=""
fi


# First, dump package lists to a temp directory
TMP="$(mktemp -d ~/packages.XXXXXXXXXX)"
trap 'rm -rvf "$TMP"' EXIT #Automatically clear this dir when we exit the script
has pacman && printf "Dumping packages from pacman...\n" && pacman -Qe > "$TMP/pacman.list"
has yay && printf "Dumping packages from yay...\n" && yay -Qe > "$TMP/yay.list"
has apt && printf "Dumping packages from apt...\n" && apt list --installed > "$TMP/apt.list"

#purge yay/pacman cache to save backup space
if has yay ; then
    yay -Sc --noconfirm
elif has pacman ; then
    $ROOT_STRING pacman -Sc --noconfirm
fi

#Do a quick test connection with the server
if [ "$HOSTNAME" == "rex" ] && rclone lsd dropbox: > /dev/null ; then
    printf "\e[0;32mSuccessfully connected to %s.\n\033[0m" "$SERVER"
elif ssh -o ConnectTimeout=5 "$SERVER" "exit" 2> /dev/null ; then
    printf "\e[0;32mSuccessfully connected to %s.\n\033[0m" "$SERVER"
else
    printf "\e[0;31mFailed to connect to %s.\n\033[0m" "$SERVER"
    exit 1
fi

if [ "$1" == "init" ] ; then
    restic -r "$PROTOCOL:$SERVER:${SERVER_DIR}${HOSTNAME}" init
elif [ "$1" == "list" ] ; then
    restic -r "$PROTOCOL:$SERVER:${SERVER_DIR}${HOSTNAME}" snapshots
else
    #Finally We do our backup
    $ROOT_STRING restic -r "$PROTOCOL:$SERVER:${SERVER_DIR}${HOSTNAME}" backup "${BACKUP_DIRS[@]}"
fi

